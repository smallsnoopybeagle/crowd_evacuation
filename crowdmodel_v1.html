<!DOCTYPE HTML>
<HTML>
<HEAD><TITLE>Crowd Movement</TITLE></HEAD>
<BODY BGCOLOR=beige style="font-size:40px;font-family:Arial"><CENTER>
<STYLE TYPE="text/css">
<!--
TD{font-family: Arial; font-size: 40px;}
--->
</STYLE>
<H1 style="font-size:50px;font-family:Arial">Crowd Movement</H1>
<!-- canvas is the place where the balls move -->
<canvas id="myCanvas" width="1000" height="1000" style="border:4px solid">
Your browser does not support the HTML5 canvas tag.
</canvas>
<style>.wslidecontainer {width: 100%;}
.wslider {-webkit-appearance: none;
	width: 100%;height: 50px;background: pink;
	}
.wslider::-webkit-slider-thumb {-webkit-appearance: none;
	width: 200px;height: 50px;background: red;
	}
</style>
<div class="wslidecontainer">
  <input type="range" min="5" max="1000" value="200" class="wslider" id="wSlider">
</div>
<p><button id="Startbutton" style="font-size:50px;font-family:Arial">Start</button>
<button id="Resetbutton" style="font-size:50px;font-family:Arial">Reset</button></p> 


<SCRIPT>
//this is the start of the javascript code
//initialisation
var cvs = document.getElementById("myCanvas");
var c = cvs.getContext("2d");
c.font = "50px Arial";
var Startbutton = document.getElementById("Startbutton"), Resetbutton = document.getElementById("Resetbutton");
var wslider = document.getElementById("wSlider");
var wslidervalue = 200, N = 500;
Startbutton.onclick = function() {interval = setInterval(Calculate, 15);Startbutton.disabled = true;}
Resetbutton.onclick = function() 
	{
	clearInterval(interval);
	xmin = 0; xmax = w/2;
	for (var i=0 ; i<N ; ++i)
		{
		x[i] = Math.round(xmax*Math.random()); //initialise the position of each person
		y[i] = Math.round(ymax*Math.random());
	 	vx[i] = Math.round(2*Math.random() + 1); //initialise the velocity of each person
		vy[i] = Math.round(2*Math.random() - 1);
		if (vx[i]==0) vx[i] = Math.round(2*Math.random() + 1);
		if (vy[i]==0) vy[i] = Math.round(2*Math.random() - 1);
		} //end of for i
	Startbutton.disabled = false;
	Calculate();
	} 

//walls
wslider.oninput = function()
	{
	wslidervalue = this.value;	// Update the slider value each time you drag the slider handle
	clearInterval(interval);
	xmin = 0; xmax = w/2;
	for (var i=0 ; i<N ; ++i)
		{
		x[i] = Math.round(xmax*Math.random()); //initialise the position of each person
		y[i] = Math.round(ymax*Math.random());
		//2 is an arbitrary constant, mr yee is limiting the movement x speed between 1 and 3 
		//random generates a random number between 0 and 1
	 	vx[i] = Math.round(2*Math.random() + 1); //initialise the velocity of each person
		vy[i] = Math.round(2*Math.random() - 1);
		if (vx[i]==0) vx[i] = Math.round(2*Math.random() + 1);
		if (vy[i]==0) vy[i] = Math.round(2*Math.random() - 1);
		} //end of for i
	Startbutton.disabled = false;
	Calculate();
	} 

//kinematics factors of the people
//yeewh assumes the acceleration is constant unless collision
//and the acceleration is infinite
var w = 1000, h = 1000;
var x = [], y = [], vx = [], vy = [], radius = [];		//arrays containing the positions, velocities and radii of all the people
var interval, xmin = 0, xmax = w/2, ymin = 0, ymax = h; 
//half and half walls
//there is more spaghetti code here than the western stall jk lol
for (var i=0 ; i<N ; i++)
	{
	radius[i] = 10;
	x[i] = Math.round(xmax*Math.random()); 	//initialise the position of each person
	y[i] = Math.round(ymax*Math.random());
 	vx[i] = Math.round(2*Math.random() + 1); //initialise the velocity of each person
	vy[i] = Math.round(2*Math.random() - 1);
	if (vx[i]==0) vx[i] = Math.round(2*Math.random() + 1);
	if (vy[i]==0) vy[i] = Math.round(2*Math.random() - 1);
	} //end of for i
Calculate();

function Calculate()
{
c.clearRect(0, 0, w, h);
c.fillStyle="black";
var doorwidth = wslidervalue;
for (var i=0; i<Math.round(h/doorwidth); i++)
	c.fillRect(w/2 - 5, (2*i + 1)*doorwidth, 10, doorwidth);	//draw a row of doors
c.fillStyle="red";
c.fillText("Door width = " + doorwidth, w/2 + 20, h-10);
for (var i=0 ; i<N ; i++)	//move each person
	{
	if (Math.abs(vx[i]) <= 1 || Math.abs(vy[i]) <= 1) 	//if a particle is too slow, randomise its speed
		{
		vx[i] = Math.round(2*Math.random() + 1);
		vy[i] = Math.round(2*Math.random() - 1);
		}
	x[i] = x[i] + vx[i];		//attempt to move the person
	y[i] = y[i] + vy[i];
	if (x[i] <= radius[i])		//person has hit the left wall
		{
		x[i] = x[i] + radius[i] - vx[i];	//move person back
		vx[i] = Math.round(2*Math.random() + 1);
		}
	if (x[i] - vx[i] <= w/2 && x[i] >= w/2 && y[i] < h && (Math.floor(y[i]/doorwidth))%2 == 1) //person has hit the row of doors
		{
		x[i] = x[i] - radius[i] - 5;
		vx[i] = Math.round(2*Math.random() - 4);			//cannot move right anymore
		vy[i] = Math.round(2*Math.random() - 1);
		}
	if (y[i] <= radius[i]) 			//person has hit the top wall
		{
		y[i] = radius[i];		//move person back
		vy[i] = -vy[i];			//reverse the velocity
		}
	if (y[i] >= ymax - radius[i]) 		//person has hit the bottom wall
		{
		y[i] = ymax - radius[i];	//move person back
		vy[i] = -vy[i];			//reverse the velocity
		}
	for (var j=0 ; j < N; j++) 	//check whether this person have collided with any other
		{
		var dx = x[i] - x[j];
		var dy = y[i] - y[j];
		var distance = Math.sqrt(dx*dx + dy*dy);			//distance between the 2 people
		if (i != j && distance <= 1.1*(radius[i] + radius[j])) 	//two people have collided
			{
			x[i] = x[i] - vx[i];			//back to original position
			y[i] = y[i] - vy[i];
			var temp = vx[i];			//exchange velocities
			vx[i] = vx[j];
			vx[j] = temp;
			if (x[i] <= w/2 && x[i] + vx[i] >= w/2 && y[i] < h && y[j] > 0 && y[j] < h && (Math.floor(y[i]/doorwidth))%2 == 1) //person has hit the row of doors
				{
				if (vx[i] >= 0)
					x[i] = x[i] - vx[i] - radius[i] - 5;		//move person back
				else 	x[i] = x[i] - radius[i] - 10;
				vx[i] = Math.round(2*Math.random() - 4);		//cannot move right anymore
				vx[j] = Math.round(2*Math.random() - 4);
				vy[i] = Math.round(2*Math.random() - 1);
				}
			if (x[j] <= w/2 && x[j] + vx[j] >= w/2 && y[i] < h && y[j] < h && (Math.floor(y[j]/doorwidth))%2 == 1) //person has hit the row of doors
				{
				x[j] = x[j] - radius[j] - 10;				//move person back
				vx[i] = Math.round(2*Math.random() - 4);		//cannot move right anymore
				vx[j] = Math.round(2*Math.random() - 4);
				vy[j] = Math.round(2*Math.random() - 1);
				}
			if (x[i] < w/2 && w/2 - x[i] < 10 && y[i] < h && y[j] > 0 && y[j] < h && Math.floor(y[i]/doorwidth)%2 == 1)	//the person is near the row of doors
				x[i] = x[i] + Math.round(2*Math.random() - 4)		//try to get out
			else x[i] = x[i] + Math.round(2*Math.random() + 1);
			//y[i] = y[i] + Math.round(2*Math.random() - 1);
			temp = vy[i];			//exchange velocities
			vy[i] = vy[j];
			vy[j] = temp;
			} //end of if (i != j)
		} //end of for j
	} //end of for i

c.fillStyle="steelblue";
for (var i=0; i<N; i++)		//draw each person		
	{
	c.beginPath();
	c.arc(x[i], y[i], radius[i], 0, 2*Math.PI);
	c.fill(); 
	}

} //end of function Calculate
//there us congestion at the doors because the people are assumed to have a field of view of 0
//so they move backwards and immediately edge forwards and hit the door and keep humping the door
//need to make people find a better path to move
//we need to give our people a FOV or non-instantaneous acceleration 


</SCRIPT>
</CENTER>




<BR><BR><BR><BR><BR><BR><BR><BR><BR><BR>
</BODY>
</HTML>
